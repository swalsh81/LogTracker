<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>title</title>
        <link rel="stylesheet" href="stylesheet.css" type="text/css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
        <script src="Chart.bundle.min.js" type="text/javascript"></script>
    
        <script type="text/javascript">
            $(document).ready(function(){
                
                $('.boss-button').click(function(){
                    var bossName = toTitleCase($(this).attr('id').replace("-", " "));
                    console.log("Get: " + bossName)
                    doChart(bossName);
                    
                    var id = $(this).attr('id');
                    
                    var hidden = $('.bkg-holder:not(.bkg-current)');
                    $(hidden).css('background-image', "url('" + id + ".jpg')");
                    
                    $('.bkg-current').removeClass('bkg-current');
                    
                    $(hidden).addClass('bkg-current');
                });                
            });
        </script>
        
        <script>
            function doChart(boss){
                var url = "https://script.google.com/macros/s/AKfycbxqRCbI0jlZUwm1-P5KHFACJxFL5yn-Oy-oJtT_Scupk89v9FjG/exec"
                
                var params = {
                    'boss':boss
                }
                
                $.ajax({
                    'url':url,
                    'data': params,
                    'success': function(result){
                        createChart(result);
                    }
                });
            }
            
            function createChart(data){
                console.log(data);
                var logs = data.logs;
                var dates = [];
                var times = [];
                var links = [];
                
                for(var i = 0; i < logs.length; i++){
                    dates.push(logs[i].date);
                    times.push(logs[i].time);
                    links.push(logs[i].link);
                }
                console.log(dates);
                console.log(times);
                console.log(links);
                var chart = $('.chart')[0];    
                var ctx = chart.getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            data: times,
                            lineTension: 0,
                            fill: false
                        }
//                                   , 
//                        {
//                            label: "reference",
//                            data:Array.apply(null, new Array(6)).map(Number.prototype.valueOf, 7),
//                            pointRadius:0
//                        }
                                  ]
                    },
                    options: {
                        legend: {
                            display: false
                        },
                        scales:{
                            yAxes:[{
                                display: true,
                                ticks:{
                                    beginAtZero: true,
                                    callback:function(value){
                                        return formatTime(value);
                                    }
                                }
                            }]
                        },
                        tooltips: {
                            custom: function(tooltip) {
                                if (!tooltip) return;
                                // disable displaying the color box;
                                    tooltip.displayColors = false;
                                },
                            callbacks: {
                                title: function(){return data.boss;},
                                label: function(tooltipItem){
                                    return [tooltipItem.xLabel, formatTime(tooltipItem.yLabel)]
                                }
                            }
                        },
                        onClick: function(evt){
                            var element = myChart.getElementsAtEvent(evt);
                            if (element.length > 0){
                                var win = window.open(links[element[0]._index], '_blank');
                                win.focus();
                            }
                        }
                    }
                });
            }
            
            function formatTime(value){
                var totalSeconds = Math.floor(value);
                var mils = value - totalSeconds;
                value = totalSeconds;
                var secs = value % 60;
                value -= secs;
                var min = value/60;
                return min + ":" + (secs + mils).toFixed(3);
            }
        </script>
        
        <script>
            function toTitleCase(str) {
                return str.replace(/\w\S*/g, function(txt){
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                });
            }
        </script>
    </head>
    <body>
        <div class="bkg-holder"></div>
        <div class="bkg-current bkg-holder"></div>
        <div class="container" id="main-div">
                <div class="button-row">
                    <div class="button-wrapper"><button class="boss-button" id="vale-guardian"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="gorseval"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="sabetha"></button></div>
                    <div class="button-wrapper"><button class="boss-button">Slothasaur</button></div>
                    <div class="button-wrapper"><button class="boss-button">Matthias</button></div>
                    <div class="button-wrapper"><button class="boss-button">Keep Construct</button></div>
                    <div class="button-wrapper"><button class="boss-button">Xera</button></div>
                    <div class="button-wrapper"><button class="boss-button">Cairn</button></div>
                    <div class="button-wrapper"><button class="boss-button">Mursaat Overseer</button></div>
                    <div class="button-wrapper"><button class="boss-button">Samarog</button></div>
                    <div class="button-wrapper"><button class="boss-button">Deimos</button></div>
                    <div class="button-wrapper"><button class="boss-button">Souless Horror</button></div>
                    <div class="button-wrapper"><button class="boss-button">Dhuum</button></div>
                    <div class="button-wrapper"><button class="boss-button">Conjured Amalgamate</button></div>
                    <div class="button-wrapper"><button class="boss-button">Largos</button></div>
                    <div class="button-wrapper"><button class="boss-button">Qadim</button></div>
                </div>
                <div class="chart-holder">
                    <canvas oncontextmenu="return false;" class="chart"></canvas>
                </div>
            </div>
        </div>
        
    </body>
</html>