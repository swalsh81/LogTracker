<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>title</title>
        <link rel="stylesheet" href="stylesheet.css" type="text/css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
        <script src="Chart.bundle.min.js" type="text/javascript"></script>
    
        <script type="text/javascript">
            
            var myChart = null;
            $(document).ready(function(){
                
                var chart = $('.chart')[0];    
                var ctx = chart.getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'line',
                    options: {
                        legend: {
                            display: false
                        },
                        tooltips: {
                            custom: function(tooltip) {
                                if (!tooltip) return;
                                // disable displaying the color box;
                                tooltip.displayColors = false;
                            }
                        },
                        elements:{
                            point:{
                                radius: 5,
                                borderWidth: 2,
                                hitRadius: 2,
                                borderColor:'rgba(0,0,0,.6)',
                                backgroundColor: 'rgba(0,0,0,0)',
                                hoverRadius: 8
                            }
                        }
                    }
                });
                
                $('.boss-button').click(function(){
                    var bossName = toTitleCase($(this).attr('id').replace("-", " "));
                    console.log("Get: " + bossName)
                    doChart(bossName);
                    
                    var id = $(this).attr('id');
                    
                    var hidden = $('.bkg-holder:not(.bkg-current)');
                    $(hidden).css('background-image', "url('" + id + ".jpg')");
                    
                    $('.bkg-current').removeClass('bkg-current');
                    
                    $(hidden).addClass('bkg-current');
                });                
                
            });

            function doChart(boss){
                var url = "https://script.google.com/macros/s/AKfycbxqRCbI0jlZUwm1-P5KHFACJxFL5yn-Oy-oJtT_Scupk89v9FjG/exec"
                
                var params = {
                    'boss':boss
                }
                
                $.ajax({
                    'url':url,
                    'data': params,
                    'success': function(result){
                        updateChart(result);
                    }
                });
            }
            
            function updateChart(data){
                console.log(data);
                var logs = data.logs;
                var dates = [];
                var times = [];
                var links = [];
                
                for(var i = 0; i < logs.length; i++){
                    dates.push(logs[i].date);
                    times.push(logs[i].time);
                    links.push(logs[i].link);
                }
                console.log(dates);
                console.log(times);
                console.log(links);

                myChart.data.labels = dates;
                myChart.data.datasets = [];
                myChart.data.datasets.push({
                            data: times,
                            lineTension: 0,
                            fill: false
                        });
                myChart.options.scales.yAxes = [];
                myChart.options.scales.yAxes.push({
                                display: true,
                                ticks:{
                                    beginAtZero: true,
                                    callback:function(value){
                                        return formatTime(value);
                                    }
                                }
                            });
                myChart.options.tooltips.callbacks.title = function(){
                                                            return data.boss;
                                                        };
                myChart.options.tooltips.callbacks.label = function(tooltipItem){
                                    return [tooltipItem.xLabel, formatTime(tooltipItem.yLabel)]
                                };
                myChart.options.onClick = function(evt){
                            var element = myChart.getElementsAtEvent(evt);
                            if (element.length > 0){
                                var win = window.open(links[element[0]._index], '_blank');
                                win.focus();
                            }
            
                };
                myChart.update();
            }
            
            function formatTime(value){
                var totalSeconds = Math.floor(value);
                var mils = value - totalSeconds;
                value = totalSeconds;
                var secs = value % 60;
                value -= secs;
                var min = value/60;
                return min + ":" + (secs + mils).toFixed(3);
            }
        </script>
        
        <script>
            function toTitleCase(str) {
                return str.replace(/\w\S*/g, function(txt){
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                });
            }
        </script>
    </head>
    <body>

        <div class="bkg bkg-holder"></div>
        <div class="bkg bkg-current bkg-holder"></div>
        <div class="bkg bkg-ev logo-bkg-gradient"></div>
        
        <div class="container" id="main-div">
                <div class="button-row">
                    <div class="button-wrapper"><button class="boss-button" id="vale-guardian"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="gorseval"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="sabetha"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="slothasor"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="matthias"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="keep-construct"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="xera"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="cairn"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="mursaat-overseer"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="samarog"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="deimos"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="soulless-horror"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="dhuum"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="amalgamate"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="largos-twins"></button></div>
                    <div class="button-wrapper"><button class="boss-button" id="qadim"></button></div>
                </div>
                <div class="chart-holder">
                    <canvas oncontextmenu="return false;" class="chart"></canvas>
                </div>
            </div>
        </div>
        
    </body>
</html>